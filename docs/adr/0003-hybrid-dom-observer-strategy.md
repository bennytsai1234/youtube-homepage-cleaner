# ADR-003: æ··åˆå¼ DOM ç›£æ§ç­–ç•¥ | Hybrid DOM Observer Strategy

| é …ç›® | å…§å®¹ |
|------|------|
| **ç‹€æ…‹** | âœ… Accepted |
| **æ—¥æœŸ** | 2025-11-01 |
| **æ±ºç­–è€…** | Benny, AI Collaborators |

---

## Context | èƒŒæ™¯

YouTube æ˜¯ä¸€å€‹ Single Page Application (SPA)ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **å‹•æ…‹è¼‰å…¥**: å…§å®¹é€é AJAX è¼‰å…¥ï¼Œä¸åˆ·æ–°æ•´é 
2. **ç„¡é™æ²å‹•**: æ»¾å‹•æ™‚æŒçºŒè¼‰å…¥æ–°å…§å®¹
3. **SPA å°èˆª**: ä½¿ç”¨ History APIï¼ŒURL è®ŠåŒ–ä¸è§¸ç™¼ page load
4. **A/B æ¸¬è©¦**: åŒæ™‚å­˜åœ¨å¤šç¨® DOM çµæ§‹

### æŒ‘æˆ° | Challenges

| å•é¡Œ | èªªæ˜ |
|------|------|
| DOMContentLoaded ä¸å¤ ç”¨ | é é¢è¼‰å…¥å¾Œé‚„æœƒå‹•æ…‹åŠ å…§å®¹ |
| é »ç¹ DOM è®ŠåŒ– | å½±ç‰‡å¡ç‰‡æŒçºŒæ–°å¢ |
| æ•ˆèƒ½è€ƒé‡ | ä¸èƒ½é »ç¹è§¸ç™¼éæ¿¾é‚è¼¯ |
| é é¢åˆ‡æ› | SPA å°èˆªéœ€é‡æ–°éæ¿¾ |

---

## Decision | æ±ºç­–

**æ¡ç”¨æ··åˆå¼ DOM ç›£æ§ç­–ç•¥**

çµåˆä¸‰ç¨®æ©Ÿåˆ¶ï¼š

### 1. CSS éœæ…‹è¦å‰‡ (æœ€é«˜å„ªå…ˆ)

åœ¨ `document-start` æ³¨å…¥ CSSï¼Œå…ƒç´ ç”¢ç”Ÿæ™‚å°±è¢«éš±è—ã€‚

### 2. MutationObserver (å‹•æ…‹å…§å®¹)

ç›£æ§ DOM è®ŠåŒ–ï¼Œå°æ–°å¢å…ƒç´ é€²è¡Œéæ¿¾ã€‚

```javascript
const observer = new MutationObserver(
    Utils.debounce(processNewContent, 150)
);
observer.observe(document.body, {
    childList: true,
    subtree: true
});
```

### 3. YouTube äº‹ä»¶ç›£è½ (SPA å°èˆª)

ç›£è½ YouTube ç‰¹æœ‰äº‹ä»¶ï¼š

```javascript
// SPA å°èˆªå®Œæˆ
document.addEventListener('yt-navigate-finish', handleNavigation);

// é é¢è³‡æ–™æ›´æ–°
document.addEventListener('yt-page-data-updated', handleDataUpdate);
```

---

## Consequences | å¾Œæœ

### æ­£é¢ | Positive

- âš¡ **æ•ˆèƒ½å„ªåŒ–**: Debounce é¿å…éåº¦è§¸ç™¼
- ğŸ”„ **å®Œæ•´è¦†è“‹**: åˆå§‹è¼‰å…¥ + å‹•æ…‹å…§å®¹ + é é¢åˆ‡æ›éƒ½èƒ½è™•ç†
- ğŸ¯ **ç²¾æº–éæ¿¾**: èƒ½è™•ç†è¤‡é›œçš„éæ¿¾é‚è¼¯ï¼ˆè§€çœ‹æ•¸è¨ˆç®—ï¼‰
- ğŸ“± **ä½ CPU ä½¿ç”¨**: Debounce é–“éš” 100-200msï¼Œä¸å½±éŸ¿ä½¿ç”¨é«”é©—

### è² é¢ | Negative

- ğŸ”§ **è¤‡é›œåº¦**: éœ€è¦ç¶­è­·å¤šå¥—ç›£æ§æ©Ÿåˆ¶
- â±ï¸ **è¼•å¾®å»¶é²**: å‹•æ…‹å…§å®¹å¯èƒ½æœ‰ 100-200ms çš„å¯è¦‹æ™‚é–“
- ğŸ§ª **æ¸¬è©¦å›°é›£**: é›£ä»¥å®Œå…¨æ¨¡æ“¬ YouTube çš„å‹•æ…‹è¡Œç‚º

---

## æ•ˆèƒ½å„ªåŒ–ç´°ç¯€ | Performance Optimizations

### Debounce ç­–ç•¥

| å ´æ™¯ | Debounce æ™‚é–“ | ç†ç”± |
|------|--------------|------|
| MutationObserver | 150ms | å¹³è¡¡å³æ™‚æ€§èˆ‡æ•ˆèƒ½ |
| æ²å‹•äº‹ä»¶ | 100ms | é¿å…æ²å‹•å¡é “ |
| Anti-Adblock æª¢æŸ¥ | 800ms | ä½é »ç‡å³å¯ |

### é¸æ“‡å™¨å„ªåŒ–

```javascript
// âœ… GOOD: é™å®šæŸ¥è©¢ç¯„åœ
container.querySelectorAll(':scope > ytd-rich-item-renderer')

// âŒ BAD: å…¨æ–‡ä»¶æŸ¥è©¢
document.querySelectorAll('ytd-rich-item-renderer')
```

### requestIdleCallback

éé—œéµæ“ä½œåœ¨ç€è¦½å™¨é–’ç½®æ™‚åŸ·è¡Œï¼š

```javascript
requestIdleCallback(() => {
    FilterStats.record(reason);
}, { timeout: 1000 });
```

---

## å¯¦ä½œæ¶æ§‹ | Implementation Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      document-start                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              StyleManager.apply()                    â”‚    â”‚
â”‚  â”‚              (CSS Rules Injected)                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOMContentLoaded                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              MutationObserver.start()                â”‚    â”‚
â”‚  â”‚              YouTube Event Listeners                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Runtime Loop                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ MutationObserver â”‚  â”‚    yt-navigate-finish        â”‚     â”‚
â”‚  â”‚    (debounced)   â”‚  â”‚    yt-page-data-updated      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                           â”‚                      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                       â–¼                                      â”‚
â”‚             VideoFilter.process()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## References | åƒè€ƒè³‡æ–™

- [MutationObserver - MDN](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [requestIdleCallback - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)
- [YouTube SPA Events](https://stackoverflow.com/questions/34077641/how-to-detect-page-navigation-on-youtube)
